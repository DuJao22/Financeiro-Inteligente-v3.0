{% extends "base.html" %}

{% block title %}Relatórios - Financeiro Inteligente{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Relatórios Financeiros</h1>
        <div class="flex flex-col sm:flex-row gap-2">
            <a href="{{ url_for('reports.export_pdf') }}" class="btn-mobile sm:w-auto bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-center">
                <i class="bi bi-file-pdf"></i> 
                <span class="ml-1">Exportar PDF</span>
            </a>
            <a href="{{ url_for('reports.export_excel') }}" class="btn-mobile sm:w-auto bg-success text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-center">
                <i class="bi bi-file-excel"></i> 
                <span class="ml-1">Exportar Excel</span>
            </a>
        </div>
    </div>

    {% if access_denied %}
    <!-- Access Denied -->
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
        <i class="bi bi-lock text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Acesso Restrito</h3>
        <p class="text-gray-600 mb-6">{{ message }}</p>
        <a href="{{ url_for('subscription.plans') }}" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark">
            Ver Planos <i class="bi bi-arrow-right ml-1"></i>
        </a>
    </div>
    {% else %}

    <!-- KPIs Cards -->
    <div class="grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
        <div class="responsive-card bg-white rounded-xl shadow-lg p-4 sm:p-6 border-l-4 border-primary hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-600 truncate">Faturamento Total</p>
                    <p class="text-lg sm:text-2xl font-bold text-primary currency">R$ {{ "%.2f"|format(total_income) }}</p>
                </div>
                <i class="bi bi-graph-up text-primary text-xl sm:text-2xl flex-shrink-0 ml-4"></i>
            </div>
        </div>
        
        <div class="responsive-card bg-white rounded-xl shadow-lg p-4 sm:p-6 border-l-4 border-danger hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-600 truncate">Gastos Totais</p>
                    <p class="text-lg sm:text-2xl font-bold text-danger currency">R$ {{ "%.2f"|format(total_expenses) }}</p>
                </div>
                <i class="bi bi-graph-down text-danger text-xl sm:text-2xl flex-shrink-0 ml-4"></i>
            </div>
        </div>
        
        <div class="responsive-card bg-white rounded-xl shadow-lg p-4 sm:p-6 border-l-4 border-{{ 'success' if net_profit >= 0 else 'warning' }} hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-600 truncate">Lucro Líquido</p>
                    <p class="text-lg sm:text-2xl font-bold text-{{ 'success' if net_profit >= 0 else 'warning' }} currency">
                        R$ {{ "%.2f"|format(net_profit) }}
                    </p>
                </div>
                <i class="bi bi-{{ 'trending-up' if net_profit >= 0 else 'trending-down' }} text-{{ 'success' if net_profit >= 0 else 'warning' }} text-xl sm:text-2xl flex-shrink-0 ml-4"></i>
            </div>
        </div>
        
        <div class="responsive-card bg-white rounded-xl shadow-lg p-4 sm:p-6 border-l-4 border-secondary hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-600 truncate">Ticket Médio</p>
                    <p class="text-lg sm:text-2xl font-bold text-secondary currency">R$ {{ "%.2f"|format(avg_ticket) }}</p>
                </div>
                <i class="bi bi-receipt text-secondary text-xl sm:text-2xl flex-shrink-0 ml-4"></i>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Monthly Performance Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Performance Mensal</h3>
            <canvas id="monthlyChart" width="400" height="300"></canvas>
        </div>
        
        <!-- Category Breakdown Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Gastos por Categoria</h3>
            <canvas id="categoryChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- Monthly Analysis Table -->
    <div class="bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold">Análise Mensal Detalhada</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Mês
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Receitas
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Despesas
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Lucro
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Margem
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for month in monthly_data[-6:] %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ month.month }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-success">
                            R$ {{ "%.2f"|format(month.income) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-danger">
                            R$ {{ "%.2f"|format(month.expenses) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium 
                            {% if month.profit >= 0 %}
                                text-success
                            {% else %}
                                text-danger
                            {% endif %}">
                            R$ {{ "%.2f"|format(month.profit) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">
                            {% if month.income > 0 %}
                                {{ "%.1f"|format((month.profit / month.income) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alerts and Insights -->
    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Financial Alerts -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="bi bi-exclamation-triangle text-warning mr-2"></i>
                Alertas Financeiros
            </h3>
            
            <div class="space-y-3">
                {% if overdue_accounts > 0 %}
                <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">
                    <i class="bi bi-clock text-red-600 mr-3"></i>
                    <div>
                        <p class="font-medium text-red-800">Contas em Atraso</p>
                        <p class="text-sm text-red-600">{{ overdue_accounts }} contas vencidas</p>
                    </div>
                </div>
                {% endif %}
                
                {% if net_profit < 0 %}
                <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <i class="bi bi-trending-down text-yellow-600 mr-3"></i>
                    <div>
                        <p class="font-medium text-yellow-800">Prejuízo no Período</p>
                        <p class="text-sm text-yellow-600">Suas despesas estão maiores que as receitas</p>
                    </div>
                </div>
                {% endif %}
                
                {% if total_expenses > total_income * 0.8 %}
                <div class="flex items-center p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <i class="bi bi-speedometer text-orange-600 mr-3"></i>
                    <div>
                        <p class="font-medium text-orange-800">Alto Gasto</p>
                        <p class="text-sm text-orange-600">Seus gastos representam mais de 80% da receita</p>
                    </div>
                </div>
                {% endif %}
                
                {% if not overdue_accounts and net_profit >= 0 %}
                <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                    <i class="bi bi-check-circle text-green-600 mr-3"></i>
                    <div>
                        <p class="font-medium text-green-800">Situação Financeira Saudável</p>
                        <p class="text-sm text-green-600">Parabéns! Suas finanças estão em dia</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Insights -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="bi bi-lightbulb text-primary mr-2"></i>
                Insights Financeiros
            </h3>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">💡 Dica de Crescimento</h4>
                    <p class="text-sm text-blue-700">
                        {% if avg_ticket > 0 %}
                            Seu ticket médio é R$ {{ "%.2f"|format(avg_ticket) }}. Tente aumentar o valor médio das vendas através de upselling.
                        {% else %}
                            Comece registrando suas transações para obter insights personalizados.
                        {% endif %}
                    </p>
                </div>
                
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-900 mb-2">📊 Meta Sugerida</h4>
                    <p class="text-sm text-purple-700">
                        {% if net_profit > 0 %}
                            Baseado no seu lucro atual, tente economizar 10% da receita mensal como reserva de emergência.
                        {% else %}
                            Foque em reduzir custos em 15% para tornar seu negócio lucrativo.
                        {% endif %}
                    </p>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-medium text-green-900 mb-2">🎯 Oportunidade</h4>
                    <p class="text-sm text-green-700">
                        Configure alertas automáticos para contas próximas do vencimento e melhore seu fluxo de caixa.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if not access_denied %}
<script>
// Monthly Performance Chart
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: {{ monthly_data[-6:]|map(attribute='month')|list|tojson }},
        datasets: [{
            label: 'Receitas',
            data: {{ monthly_data[-6:]|map(attribute='income')|list|tojson }},
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4
        }, {
            label: 'Despesas',
            data: {{ monthly_data[-6:]|map(attribute='expenses')|list|tojson }},
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4
        }, {
            label: 'Lucro',
            data: {{ monthly_data[-6:]|map(attribute='profit')|list|tojson }},
            borderColor: 'rgb(37, 99, 235)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        }
    }
});

// Category Breakdown Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: {{ category_data|map(attribute='0')|list|tojson }},
        datasets: [{
            data: {{ category_data|map(attribute='1')|list|tojson }},
            backgroundColor: [
                'rgb(239, 68, 68)',
                'rgb(245, 158, 11)',
                'rgb(34, 197, 94)',
                'rgb(37, 99, 235)',
                'rgb(147, 51, 234)',
                'rgb(236, 72, 153)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
