{% extends "base.html" %}

{% block title %}Metas Financeiras{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">🎯 Metas Financeiras</h1>
            <p class="text-gray-600">Defina e acompanhe seus objetivos financeiros</p>
        </div>
        <a href="{{ url_for('goals.create_goal') }}" class="mt-4 sm:mt-0 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
            <i class="bi bi-plus-circle"></i>
            <span>Nova Meta</span>
        </a>
    </div>

    <!-- Overview Cards -->
    {% if active_goals %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Objetivo</p>
                    <p class="text-2xl font-bold text-gray-900">{{ format_currency(total_target) }}</p>
                </div>
                <div class="bg-primary/10 p-3 rounded-lg">
                    <i class="bi bi-bullseye text-primary text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Atingido</p>
                    <p class="text-2xl font-bold text-green-600">{{ format_currency(total_current) }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="bi bi-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Progresso Geral</p>
                    <p class="text-2xl font-bold text-blue-600">{{ "%.1f"|format(overall_progress) }}%</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="bi bi-graph-up text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Active Goals -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">🎯 Metas Ativas</h2>
        {% if active_goals %}
        <div class="grid gap-6">
            {% for goal in active_goals %}
            <div class="bg-white rounded-lg shadow border-l-4 {% if goal.is_overdue() %}border-red-500{% else %}border-primary{% endif %} p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center">
                    <div class="flex-1 mb-4 lg:mb-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">{{ goal.title }}</h3>
                            {% if goal.is_overdue() %}
                            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Atrasada</span>
                            {% elif goal.get_days_remaining() and goal.get_days_remaining() <= 30 %}
                            <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Próxima do prazo</span>
                            {% endif %}
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600">
                            <div>💰 {{ format_currency(goal.current_amount) }} de {{ format_currency(goal.target_amount) }}</div>
                            {% if goal.target_date %}
                            <div>📅 Meta: {{ goal.target_date.strftime('%d/%m/%Y') if goal.target_date else '-' }}</div>
                            {% endif %}
                            {% if goal.get_days_remaining() is not none %}
                            <div>⏰ {{ goal.get_days_remaining() }} dias restantes</div>
                            {% endif %}
                        </div>

                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">Progresso</span>
                                <span class="text-sm font-medium text-gray-900">{{ "%.1f"|format(goal.get_progress_percentage()) }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="{% if goal.is_overdue() %}bg-red-500{% else %}bg-primary{% endif %} h-2 rounded-full transition-all duration-300" 
                                     style="width: {{ goal.get_progress_percentage() }}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button onclick="updateProgress({{ goal.id }}, {{ goal.current_amount }})" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                            💰 Atualizar
                        </button>
                        <a href="{{ url_for('goals.edit_goal', goal_id=goal.id) }}" 
                           class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors text-center">
                            ✏️ Editar
                        </a>
                        {% if goal.current_amount >= goal.target_amount %}
                        <form action="{{ url_for('goals.complete_goal', goal_id=goal.id) }}" method="POST" class="inline">
                            <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-yellow-700 transition-colors">
                                🏆 Concluir
                            </button>
                        </form>
                        {% endif %}
                        <form action="{{ url_for('goals.delete_goal', goal_id=goal.id) }}" method="POST" class="inline" 
                              onsubmit="return confirm('Tem certeza que deseja excluir esta meta?')">
                            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors">
                                🗑️ Excluir
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-8 text-center">
            <div class="mb-4">
                <i class="bi bi-bullseye text-6xl text-gray-300"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma meta ativa</h3>
            <p class="text-gray-600 mb-4">Crie sua primeira meta financeira para começar a organizar seus objetivos!</p>
            <a href="{{ url_for('goals.create_goal') }}" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                Criar primeira meta
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Completed Goals -->
    {% if completed_goals %}
    <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-4">🏆 Metas Concluídas</h2>
        <div class="grid gap-4">
            {% for goal in completed_goals %}
            <div class="bg-green-50 rounded-lg border border-green-200 p-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="text-lg font-semibold text-green-800">{{ goal.title }}</h3>
                            <span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">✓ Concluída</span>
                        </div>
                        <div class="text-sm text-green-700">
                            💰 {{ format_currency(goal.target_amount) }} | 📅 {{ goal.target_date.strftime('%d/%m/%Y') if goal.target_date else '-' }}
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <form action="{{ url_for('goals.reactivate_goal', goal_id=goal.id) }}" method="POST" class="inline">
                            <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors">
                                🔄 Reativar
                            </button>
                        </form>
                        <form action="{{ url_for('goals.delete_goal', goal_id=goal.id) }}" method="POST" class="inline" 
                              onsubmit="return confirm('Tem certeza que deseja excluir esta meta?')">
                            <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                                🗑️ Excluir
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Update Progress Modal -->
<div id="updateProgressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold mb-4">Atualizar Progresso</h3>
        <form id="updateProgressForm">
            <div class="mb-4">
                <label for="newAmount" class="block text-sm font-medium text-gray-700 mb-2">Novo Valor</label>
                <input type="number" id="newAmount" step="0.01" min="0" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="flex space-x-2">
                <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Salvar
                </button>
                <button type="button" onclick="closeUpdateModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentGoalId = null;

function updateProgress(goalId, currentAmount) {
    currentGoalId = goalId;
    document.getElementById('newAmount').value = currentAmount;
    document.getElementById('updateProgressModal').classList.remove('hidden');
}

function closeUpdateModal() {
    document.getElementById('updateProgressModal').classList.add('hidden');
    currentGoalId = null;
}

document.getElementById('updateProgressForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newAmount = parseFloat(document.getElementById('newAmount').value);
    
    fetch(`/goals/update_progress/${currentGoalId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amount: newAmount })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload page
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Erro ao atualizar progresso');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao atualizar progresso');
    });
    
    closeUpdateModal();
});

// Close modal when clicking outside
document.getElementById('updateProgressModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUpdateModal();
    }
});
</script>
{% endblock %}